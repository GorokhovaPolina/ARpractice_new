<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AR Dino — intermediate</title>
<style>
  html,body{height:100%;margin:0;background:#111;color:#fff;font-family:Arial}
  #hud{position:fixed;left:12px;top:12px;z-index:999;padding:8px 12px;background:rgba(0,0,0,0.5);border-radius:8px}
  #hint{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:999;padding:6px 10px;background:rgba(0,0,0,0.45);border-radius:8px}
  a-scene{width:100%;height:100%;position:fixed;top:0;left:0}
  #game-over{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1000;
             background:rgba(0,0,0,0.8);padding:14px;border-radius:10px}
</style>
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>
</head>
<body>
<div id="hud">Score: <span id="score">0</span></div>
<div id="hint">Point camera at Hiro marker — Tap / SPACE to jump</div>
<div id="game-over"><strong>GAME OVER</strong><div id="final"></div><button id="retry">Retry</button></div>

<a-scene embedded vr-mode-ui="enabled:false" 
         arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;">
  <a-assets>
    <a-asset-item id="dino-model" src="assets/tyrannosaurus_rex_rig/dino.gltf"></a-asset-item>
  </a-assets>

  <a-marker id="hiro" type="pattern" url="./patt.hiro" emitevents="true" smooth="true">
    <a-entity id="world" position="0 0 0">
      <!-- player -->
      <a-entity id="player" position="0 0.2 0" scale="0.12 0.12 0.12">
        <a-entity id="model" gltf-model="#dino-model" visible="false"></a-entity>
        <a-box id="fallback" depth="0.6" height="0.8" width="0.3" material="color:#4CAF50" visible="true"></a-box>
      </a-entity>

      <a-entity id="obstacles"></a-entity>

      <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" material="color:#2e7d32;opacity:0.4"></a-plane>
    </a-entity>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<script>
(function(){
  // DOM
  const marker = document.getElementById('hiro');
  const player = document.getElementById('player');
  const model = document.getElementById('model');
  const fallback = document.getElementById('fallback');
  const obsContainer = document.getElementById('obstacles');
  const scoreEl = document.getElementById('score');
  const hint = document.getElementById('hint');
  const gameOverEl = document.getElementById('game-over');
  const finalEl = document.getElementById('final');
  const retryBtn = document.getElementById('retry');

  // game state
  let markerVisible = false;
  let running = false;
  let jumping = false;
  let isOnGround = true;
  let vy = 0;
  const GRAV = -0.018;
  const JUMP_V = 0.45;
  const baseY = 0.2;
  let obstacles = [];
  let spawnTimer = null;
  let raf = null;
  let score = 0;
  const SPAWN_INTERVAL = 1200;
  const OB_SPEED = 0.012;

  // show model if available
  const asset = document.getElementById('dino-model');
  if (asset) asset.addEventListener('loaded', ()=>{ model.setAttribute('visible','true'); fallback.setAttribute('visible','false'); }, {once:true});

  // marker events
  marker.addEventListener('markerFound', ()=>{ markerVisible = true; hint.textContent = 'Marker found — Tap/SPACE to jump'; startGameIfNeeded(); });
  marker.addEventListener('markerLost',  ()=>{ markerVisible = false; hint.textContent = 'Point camera at Hiro marker'; pauseGame(); });

  // input
  window.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); doJump(); }});
  window.addEventListener('touchstart', e => { e.preventDefault(); doJump(); }, {passive:false});

  retryBtn.addEventListener('click', ()=>{ resetGame(); startGameIfNeeded(); });

  // jump
  function doJump(){
    if (!running || !markerVisible || jumping || !isOnGround) return;
    vy = JUMP_V;
    jumping = true;
    isOnGround = false;
  }

  // obstacle creation
  function createObstacle(){
    const id = 'o' + Date.now();
    const el = document.createElement('a-box');
    const h = 0.25 + Math.random()*0.6; // height
    el.setAttribute('depth', 0.2);
    el.setAttribute('height', h);
    el.setAttribute('width', 0.2);
    el.setAttribute('material','color:#8B4513');
    // spawn to the right of player, z small random
    const x = 0.9 + Math.random()*0.6;
    const y = h/2;
    const z = (Math.random()-0.5)*0.4;
    el.setAttribute('position', `${x} ${y} ${z}`);
    el.setAttribute('id', id);
    obsContainer.appendChild(el);
    obstacles.push(el);
  }

  // start/stop generation
  function startSpawning(){
    if (spawnTimer) return;
    spawnTimer = setInterval(()=>{ if (running) createObstacle(); }, SPAWN_INTERVAL);
  }
  function stopSpawning(){ if (spawnTimer){ clearInterval(spawnTimer); spawnTimer = null; } }

  // game loop
  function loop(){
    // physics for player
    if (running && markerVisible){
      // integrate
      if (!isOnGround){
        vy += GRAV;
        let pos = player.object3D.position;
        pos.y += vy;
        // land
        if (pos.y <= baseY){
          pos.y = baseY;
          vy = 0;
          isOnGround = true;
          jumping = false;
        }
        player.object3D.position.copy(pos);
      }

      // move obstacles
      for (let i = obstacles.length-1; i >=0; i--){
        const ob = obstacles[i];
        if (!ob || !ob.object3D) { obstacles.splice(i,1); continue; }
        ob.object3D.position.x -= OB_SPEED;
        // remove if passed
        if (ob.object3D.position.x < -1.2){
          // passed -> score
          score += 10;
          scoreEl.textContent = score;
          if (ob.parentNode) ob.parentNode.removeChild(ob);
          obstacles.splice(i,1);
          continue;
        }
        // collision (simple): horizontal distance + vertical check
        const p = player.object3D.position;
        const dx = Math.abs(p.x - ob.object3D.position.x);
        const dz = Math.abs(p.z - ob.object3D.position.z);
        const vyPos = p.y;
        if (dx < 0.25 && dz < 0.25 && vyPos <= (ob.object3D.position.y - ob.getAttribute('height')/2 + 0.05)){
          // collided while on ground or low -> game over
          endGame();
          break;
        }
      }
    }

    raf = requestAnimationFrame(loop);
  }

  function startGameIfNeeded(){
    if (!markerVisible) return;
    if (running) return;
    running = true;
    score = 0; scoreEl.textContent = score;
    hint.style.display = 'block';
    gameOverEl.style.display = 'none';
    startSpawning();
    if (!raf) loop();
  }

  function pauseGame(){
    running = false;
    stopSpawning();
    if (raf){ cancelAnimationFrame(raf); raf = null; }
  }

  function endGame(){
    running = false;
    stopSpawning();
    if (raf){ cancelAnimationFrame(raf); raf = null; }
    gameOverEl.style.display = 'block';
    finalEl.textContent = 'Score: ' + score;
  }

  function resetGame(){
    // clear obstacles
    obstacles.forEach(o => { if (o.parentNode) o.parentNode.removeChild(o); });
    obstacles = [];
    // reset player
    if (player && player.object3D) player.object3D.position.set(0, baseY, 0);
    vy = 0; jumping = false; isOnGround = true;
    score = 0; scoreEl.textContent = score;
    gameOverEl.style.display = 'none';
  }

  // safety: ensure player.object3D exists after scene load
  document.querySelector('a-scene').addEventListener('loaded', ()=> {
    if (player && player.object3D) player.object3D.position.set(0, baseY, 0);
  });

  // stop everything when page hidden
  document.addEventListener('visibilitychange', ()=> { if (document.hidden) pauseGame(); });

  // init minimal: allow spawn when marker found
})();
</script>
</body>
</html>
